name: Rencher
on: 
  workflow_dispatch: 

jobs:
  linux-job:
    name: Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          tags: rencher-builder:latest
          load: true

      - name: Create container and extract files
        id: extract
        run: |
          docker create --name temp-container rencher-builder:latest
          docker cp temp-container:/app/build ./output/
          FREEZE_DIR=$(docker run rencher-builder python3 -c "import sysconfig; print(f'exe.{sysconfig.get_platform()}-{sysconfig.get_python_version()}')")
          echo "FREEZE_DIR=$FREEZE_DIR" >> $GITHUB_OUTPUT
          docker rm temp-container

      - name: Upload frozen files artifact
        uses: actions/upload-artifact@v4
        with:
          name: Rencher-Linux-Portable
          path: ./output/${{ steps.extract.outputs.FREEZE_DIR }}/

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Rencher-Linux-AppImage
          path: ./output/Rencher-x86_64.AppImage

  windows-job:
    name: Windows
    runs-on: windows-2025
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-python 
            mingw-w64-ucrt-x86_64-python-pip 
            mingw-w64-ucrt-x86_64-nsis
      - name: Install dependencies
        run: python build-aux/install_deps.py

      - name: Freeze Rencher
        id: freeze
        run: |
          python build-aux/freeze.py
          FREEZE_DIR=$(python3 -c "import sysconfig; print(f'exe.{sysconfig.get_platform()}-{sysconfig.get_python_version()}')")
          echo "FREEZE_DIR=$FREEZE_DIR" >> $GITHUB_OUTPUT

      - name: Build NSIS installer
        run: makensis build-aux/build_installer.nsi

      - name: Upload frozen files artifact
        uses: actions/upload-artifact@v4
        with:
          name: Rencher-Windows-Portable
          path: ./build/${{ steps.freeze.outputs.FREEZE_DIR }}

      - name: Upload NSIS installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: Rencher-Windows-Installer
          path: ./build/RencherInstaller.exe
